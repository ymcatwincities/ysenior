<?php

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\file\FileInterface;

/**
 * Implements hook_ENTITY_TYPE_access().
 */
function views_data_export_file_access(EntityInterface $entity, $operation, AccountInterface $account) {
  /* @var $entity FileInterface */
  if ($operation == 'download') {
    // Grant access to download the generate export if it was generated by the
    // current user.
    $pattern = '/\/\/views_data_export\/(?<uid>\d+)-\d+-.+\.csv$/';
    preg_match($pattern, $entity->getFileUri(), $matches);
    if ($matches['uid'] == $account->id()) {
      return AccessResult::allowed();
    }
  }
}

